# Как пользоваться

`client.py` это основная библиотека. Её зависимость — `items.py`, нужна для безопасных операций с файлом списка. Единственная зависимость не из стандартной библиотеки: `pexpect` (`telnetlib` из стандартной библиотеки скоро будет deprecated). `pexpect` не реализует telnet самостоятельно, поэтому на системе должен быть установлен пакет, предоставляющий telnet. На Debian это выглядит так:

```
# apt install -y telnet python3-pexpect
```

Чтобы скрипт работал, надо задать через environment или в самих скриптах переменные из `env.example`, а также эти параметры в `openvpn.conf`: 

```
# для telnet-интерфейса, нужен чтобы убить сессию
management 127.0.0.1 11528 

# чтобы скрипт блокировки работал
script-security 2

# путь к скрипту
# скрипт и его лог-файл должны быть запускаемы 
# от пользователя, от которого раннится демон openvpn
tls-verify /opt/openvpn/etc/tls_verify.sh
```

Для Wireguard дополнительных действий не требуется, но демон Wireguard обычно работает от root, поэтому в `client.py` предусмотрен флаг `WG_AS_SUDO`, который добавляет `sudo` в начало используемых команд. Значение по умолчанию — `False`, скрипт также можно запускать от рута изначально. 

Дальше можно тянуть Python библиотеку и управлять блокировкой через неё:

```python
from client import OpenVPNClient as OVPN
from client import WireguardClient as WG

# Здесь CN блокируемого без 'CN=' в начале
foo = OVPN("foobar")
foo.block() # убивает сессию, добавляет CN в банлист
foo.unblock() # разблокирует клиента

# Здесь — ПУБЛИЧНЫЙ ключ клиента. 
bar = WG("6cCLfSYbyPcRODrH3yNuxiaqNZ212345YpzB6LAb3nM=")
bar.block() # null-route-ит клиента через 127.0.0.2
bar.unblock("10.64.1.7") # нужно задать старый айпи, скрипт не хранит его
```

Учтите, что для успешной блокировки и разблокировки процесс, запускающий библиотеку, должен иметь право **чтения и записи на директорию, где находится файл blocklist**. 

Библиотека идемпотентная, т.е. можно заблокировать уже заблокированного или разблокировать уже разблокированного без ошибок. 

Логи выводятся как в `stdout`, так и записываются (уже уровнем повыше, `DEBUG`) в файл, находящийся в той же директории, откуда исполняется скрипт. Ротация автоматическая, местонахождение файла регулируется через `BLOCKER_LOG_FILE`.
